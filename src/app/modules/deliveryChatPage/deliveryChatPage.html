<div class="delivery-chat-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <div class="page-title">
          <button class="btn btn-outline-primary btn-sm me-3" (click)="goBack()">
            <i class="fas fa-arrow-right me-2"></i>
            العودة
          </button>
          <h4 class="mb-0">
            <i class="fas fa-comments me-2"></i>
            محادثة التوصيل
          </h4>
        </div>
        <div class="page-info" *ngIf="request">
          <small class="text-muted">
            طلب رقم: {{requestId}}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <p class="mt-3 text-muted">جاري تحميل المحادثة...</p>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <div class="container-fluid">
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{error}}
        <div class="mt-3">
          <button class="btn btn-outline-danger btn-sm" (click)="goBack()">
            العودة للطلبات
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" *ngIf="!isLoading && !error && request">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <!-- Request Card Section (Fixed at top) -->
          <div class="request-card-section">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-file-alt me-2"></i>
                  تفاصيل الطلب
                </h6>
              </div>
              <div class="card-body p-0">
                <app-request-card 
                  [request]="request"
                  [isViewOnly]="true"
                  [showActions]="false">
                </app-request-card>
                <!-- Debug info -->
                <div *ngIf="request" class="p-3 bg-light border-top">
                  <small class="text-muted">
                    Debug: Request ID: {{request.id}}, Offer ID: {{request.offerId}}, Status: {{request.status}}
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Section -->
          <div class="chat-section">
            <div class="card shadow-sm">
              <div class="card-body p-0">
                <ng-container *ngIf="chatId && chatId > 0; else chatLoading">
                  <app-delivery-chat 
                    [chatId]="chatId"
                    [requestId]="requestId">
                  </app-delivery-chat>
                </ng-container>
                <ng-template #chatLoading>
                  <div class="text-center py-4 text-muted">
                    <div class="spinner-border text-primary mb-2" role="status">
                      <span class="visually-hidden">جاري تهيئة المحادثة...</span>
                    </div>
                    <div>جاري تهيئة المحادثة...</div>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>

          <!-- Action Buttons Section (for offer owners) -->
          <div class="action-buttons-section" *ngIf="canAcceptOrReject()">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-cogs me-2"></i>
                  إجراءات الطلب
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-6">
                    <button 
                      type="button" 
                      class="btn btn-success w-100" 
                      (click)="acceptRequest()"
                      [disabled]="isProcessing">
                      <span *ngIf="isProcessing && actionType === 'accept'" class="spinner-border spinner-border-sm me-2"></span>
                      <i class="fas fa-check me-2" *ngIf="!(isProcessing && actionType === 'accept')"></i>
                      قبول الطلب
                    </button>
                  </div>
                  <div class="col-6">
                    <button 
                      type="button" 
                      class="btn btn-danger w-100" 
                      (click)="rejectRequest()"
                      [disabled]="isProcessing">
                      <span *ngIf="isProcessing && actionType === 'reject'" class="spinner-border spinner-border-sm me-2"></span>
                      <i class="fas fa-times me-2" *ngIf="!(isProcessing && actionType === 'reject')"></i>
                      رفض الطلب
                    </button>
                  </div>
                </div>
                <div class="mt-3">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    بقبول الطلب سيتم تحويل الأموال للموصل وتأكيد العملية
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Required -->
  <div class="auth-required" *ngIf="!isAuthenticated() && !isLoading">
    <div class="container-fluid">
      <div class="alert alert-warning text-center">
        <i class="fas fa-lock me-2"></i>
        يجب تسجيل الدخول للوصول إلى المحادثة
        <div class="mt-3">
          <button class="btn btn-primary btn-sm" routerLink="/auth/login">
            تسجيل الدخول
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
