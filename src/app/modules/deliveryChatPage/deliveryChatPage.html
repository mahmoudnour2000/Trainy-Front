<div class="delivery-chat-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <div class="page-title">
          <button class="btn btn-outline-primary btn-sm me-3" (click)="goBack()">
            <i class="fas fa-arrow-right me-2"></i>
            العودة
          </button>
          <h4 class="mb-0">
            <i class="fas fa-comments me-2"></i>
            محادثة التوصيل
          </h4>
        </div>
        <!-- <div class="page-info" *ngIf="request">
          <small class="text-muted">
            طلب رقم: {{requestId}}
          </small>
        </div> -->
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <p class="mt-3 text-muted">جاري تحميل المحادثة...</p>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <div class="container-fluid">
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{error}}
        <div class="mt-3">
          <button class="btn btn-outline-danger btn-sm" (click)="goBack()">
            العودة للطلبات
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" *ngIf="!isLoading && !error && request">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <!-- Request Card Section (Fixed at top) -->
          <div class="request-card-section">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-file-alt me-2"></i>
                  تفاصيل الطلب
                </h6>
              </div>
              <div class="card-body p-0">
                <app-request-card 
                  [request]="request"
                  [isViewOnly]="true"
                  [showActions]="false">
                </app-request-card>
                <!-- Debug info -->
                <!-- <div *ngIf="request" class="p-3 bg-light border-top">
                  <small class="text-muted">
                    Debug: Request ID: {{request.id}}, Offer ID: {{request.offerId}}, Status: {{request.status}}, Chat ID: {{chatId}}
                  </small>
                </div> -->
              </div>
            </div>
          </div>

          <!-- Chat Section -->
          <div class="chat-section">
            <div class="card shadow-sm">
              <div class="card-body p-0">
                <ng-container *ngIf="chatId && chatId > 0; else chatLoading">
                  <app-delivery-chat 
                    [chatId]="chatId"
                    [requestId]="requestId"
                    [offerId]="offerId"
                    [courierId]="courierId">
                  </app-delivery-chat>
                </ng-container>
                <ng-template #chatLoading>
                  <div class="text-center py-4 text-muted">
                    <div class="spinner-border text-primary mb-2" role="status">
                      <span class="visually-hidden">جاري تهيئة المحادثة...</span>
                    </div>
                    <div>جاري تهيئة المحادثة...</div>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>

          <!-- Action Buttons Section (for offer owners) -->
          <div class="action-buttons-section" *ngIf="isOfferOwner()">
            <div class="card shadow-sm">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-cogs me-2"></i>
                  إجراءات الطلب
                </h6>
              </div>
              <div class="card-body">
                <!-- Accept/Reject buttons when request is pending -->
                <div class="row g-3" *ngIf="canAcceptOrReject()">
                  <div class="col-6">
                    <button 
                      type="button" 
                      class="btn btn-success w-100" 
                      (click)="acceptRequest()"
                      [disabled]="isProcessing">
                      <span *ngIf="isProcessing && actionType === 'accept'" class="spinner-border spinner-border-sm me-2"></span>
                      <i class="fas fa-check me-2" *ngIf="!(isProcessing && actionType === 'accept')"></i>
                      قبول الطلب
                    </button>
                  </div>
                  <div class="col-6">
                    <button 
                      type="button" 
                      class="btn btn-danger w-100" 
                      (click)="rejectRequest()"
                      [disabled]="isProcessing">
                      <span *ngIf="isProcessing && actionType === 'reject'" class="spinner-border spinner-border-sm me-2"></span>
                      <i class="fas fa-times me-2" *ngIf="!(isProcessing && actionType === 'reject')"></i>
                      رفض الطلب
                    </button>
                  </div>
                  <div class="col-12">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      بقبول الطلب سيتم تحويل حالة الطلب إلى "قيد التنفيذ"
                    </small>
                  </div>
                </div>

                <!-- Complete delivery button when request is accepted -->
                <div class="row g-3" *ngIf="canCompleteDelivery()">
                  <div class="col-12">
                    <button 
                      type="button" 
                      class="btn btn-primary w-100" 
                      (click)="showCompletionConfirmation()"
                      [disabled]="isProcessing">
                      <span *ngIf="isProcessing && actionType === 'complete'" class="spinner-border spinner-border-sm me-2"></span>
                      <i class="fas fa-check-circle me-2" *ngIf="!(isProcessing && actionType === 'complete')"></i>
                      تم التوصيل بنجاح
                    </button>
                  </div>
                  <div class="col-12">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                      سيتم تحويل الأموال للموصل فور التأكيد ولن يمكن التراجع عن هذا الإجراء
                  </small>
                  </div>
                </div>

                <!-- Status message for completed delivery -->
                <div class="text-center" *ngIf="isDeliveryCompleted()">
                  <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    تم اكتمال التوصيل بنجاح
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Required -->
  <div class="auth-required" *ngIf="!isAuthenticated() && !isLoading">
    <div class="container-fluid">
      <div class="alert alert-warning text-center">
        <i class="fas fa-lock me-2"></i>
        يجب تسجيل الدخول للوصول إلى المحادثة
        <div class="mt-3">
          <button class="btn btn-primary btn-sm" routerLink="/auth/login">
            تسجيل الدخول
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Completion Confirmation Modal -->
  <div class="modal fade" id="completionModal" tabindex="-1" aria-labelledby="completionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="completionModalLabel">تأكيد اكتمال التوصيل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" [disabled]="isProcessing"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>تنبيه مهم:</strong>
          </div>
          <p class="mb-3">
            بهذا التأكيد على عملية التوصيل فإنه ليس من حقك الشكوى على أي شيء يخص عملية التوصيل 
            ويجب التأكد بشكل كامل من صحة الشيء الذي تم توصيله.
          </p>
          <p class="text-muted mb-0">
            <i class="fas fa-info-circle me-1"></i>
            سيتم تحويل الأموال للموصل فور التأكيد ولن يمكن التراجع عن هذا الإجراء.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" [disabled]="isProcessing">
            إلغاء
          </button>
          <button type="button" class="btn btn-primary" (click)="completeDelivery()" [disabled]="isProcessing">
            <span class="spinner-border spinner-border-sm me-2" *ngIf="isProcessing && actionType === 'complete'"></span>
            <i class="fas fa-check me-2" *ngIf="!(isProcessing && actionType === 'complete')"></i>
            موافق - تأكيد التوصيل
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
