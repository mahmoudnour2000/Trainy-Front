<div class="tracking-container">
  <div *ngIf="trainData">
    <h2>ğŸš‚ ØªØªØ¨Ø¹ Ø§Ù„Ù‚Ø·Ø§Ø± Ø±Ù‚Ù… {{ trainData.TrainNo }}</h2>
    <div class="guide-badge" *ngIf="isGuide">
      <span>ğŸ›¡ï¸ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø±Ø´Ø¯ (Guide)</span>
    </div>
    <div class="guide-badge not-guide" *ngIf="!isGuide">
      <span>ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø±Ø´Ø¯ (Guide)</span>
      <button class="btn btn-outline-primary request-guide-btn" (click)="requestGuideRole()" [disabled]="isRequestingGuide">
        <span *ngIf="isRequestingGuide" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø±Ø´Ø¯
      </button>
    </div>
    <div class="station-cards-row">
      <div class="station-card current">
        <h3>Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ trainData.CurrentStationName }}</p>
        <p *ngIf="trainData.Latitude && trainData.Longitude"><strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> {{ trainData.Latitude }}, {{ trainData.Longitude }}</p>
        <p *ngIf="!trainData.Latitude || !trainData.Longitude" class="text-danger">Ù„Ø§ ØªØªÙˆÙØ± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
      </div>
      <div class="station-card next">
        <h3>Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</h3>
        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ trainData.NextStationName }}</p>
        <!-- Coordinates for next station are not available in current data model -->
        <p class="text-muted">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</p>
      </div>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>
  
  <div *ngIf="trainData" class="train-info">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <div>
        <p><strong>ğŸš‚ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø§Ø±:</strong> {{ trainData.TrainNo }}</p>
        <p><strong>ğŸ“ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> {{ trainData.CurrentStationName }}</p>
        <p><strong>ğŸ¯ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</strong> {{ trainData.NextStationName }}</p>
      </div>
      <div>
        <p><strong>ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> {{ trainData.Latitude }}, {{ trainData.Longitude }}</p>
        <p><strong>â° ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> {{ trainData.ExpectedArrival | date:'medium' }}</p>
        <p><strong>ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø©:</strong> {{ trainData.Speed }} ÙƒÙ…/Ø³</p>
      </div>
      <div>
        <p><strong>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</strong> {{ trainData.DistanceToNextStation }} ÙƒÙ…</p>
        <p><strong>ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ trainData.Status }}</p>
        <p><strong>ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> {{ trainData.LastUpdated | date:'medium' }}</p>
      </div>
    </div>
  </div>

  <div *ngIf="!trainData && !isLoading" class="alert alert-info">
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 48px; margin-bottom: 10px;">ğŸš‚</div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø·Ø§Ø±...</p>
    </div>
  </div>

  <div *ngIf="trainData" class="map-container">
    <div *ngIf="trainData.Latitude && trainData.Longitude; else noCoordsMap">
      <div leaflet [leafletOptions]="options" [leafletLayers]="layers"></div>
    </div>
    <ng-template #noCoordsMap>
      <div class="no-coords-message">Ù„Ø§ ØªØªÙˆÙØ± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
    </ng-template>
  </div>

  <ng-container *ngIf="isGuide && trainData">
    <div class="controls">
      <div class="buttons-container">
        <button class="btn btn-primary" (click)="updateGps()" [disabled]="isLoading">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          ğŸ“ ØªØ­Ø¯ÙŠØ« GPS
        </button>
      </div>

      <h3>âœï¸ ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ</h3>
      <form #manualForm="ngForm" (ngSubmit)="updateManual()">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="form-group">
            <label for="latitude">ğŸ“ Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
            <input 
              type="number" 
              id="latitude"
              class="form-control" 
              [(ngModel)]="manualLat" 
              name="manualLat" 
              placeholder="Ù…Ø«Ø§Ù„: 30.0444"
              required
              step="0.000001"
              min="-90"
              max="90"
            >
          </div>
          <div class="form-group">
            <label for="longitude">ğŸ“ Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label>
            <input 
              type="number" 
              id="longitude"
              class="form-control" 
              [(ngModel)]="manualLng" 
              name="manualLng" 
              placeholder="Ù…Ø«Ø§Ù„: 31.2357"
              required
              step="0.000001"
              min="-180"
              max="180"
            >
          </div>
          <div class="form-group">
            <label for="arrival">â° ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„</label>
            <input 
              type="datetime-local" 
              id="arrival"
              class="form-control" 
              [(ngModel)]="manualArrival" 
              name="manualArrival"
              required
            >
          </div>
        </div>
        <button 
          type="submit" 
          class="btn btn-success" 
          [disabled]="manualForm.invalid || isLoading"
        >
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          âœ… ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ
        </button>
      </form>
    </div>
  </ng-container>

  <!-- Debug panel for development -->
  <div *ngIf="trainData" class="debug-panel" style="margin-top: 32px; background: #f1f3f6; border: 1.5px dashed #007bff; border-radius: 8px; padding: 16px; color: #222;">
    <h4 style="color: #007bff; margin-bottom: 8px;">ï¿½ï¿½ï¸ Debug Panel</h4>
    <div><strong>Latitude:</strong> {{ trainData.Latitude }}</div>
    <div><strong>Longitude:</strong> {{ trainData.Longitude }}</div>
    <div><strong>Raw trainData:</strong></div>
    <pre style="background: #e9ecef; border-radius: 6px; padding: 8px; font-size: 13px; overflow-x: auto;">{{ trainData | json }}</pre>
  </div>
</div>